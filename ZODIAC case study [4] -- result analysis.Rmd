---
title: "Result analysis"
author: "Tianyi Wang"
output: html_document
---

In this file, we will take a look at our results generated by three different approaches and generate a merged result which is the sum of the weighted results from the three approaches.

```{r}
setwd("C://Users/Think/Desktop/case")
bys=read.csv("result_bayesian.csv")
xgb=read.csv("result_xgboost_5000_rounds.csv")
seq=read.csv("result_seq2seq_submit.csv")[,2:3]
sim=read.csv("seq data monthly.csv")
sim1=sim[,8:10]
sim2=rowSums(sim1)
format=read.csv("customer_preds.csv",as.is = TRUE)
number=data.frame('customer_id'=1:20000,sim2)
for (i in 1:20000){
  id=format$customer_id[i]
  format$three_month_pred[i]=number$sim2[number$customer_id==id]
}
last_3_months=format
```

We first want to see how the results vary among different approaches. We will select some customers of different kind (from low value to high value) and visualize the relevant results. We also include the total sales in the past 3 months (2017 March - 2017 May) which serves as kind of a benchmark.

```{r}
index=which(bys$three_month_pred>50 & bys$three_month_pred<80)
result=rbind(xgb[index,],seq[index,],bys[index,],last_3_months[index,])
n=length(index)
result['model']=c(rep("boosting tree",n),rep("seq2seq",n),rep("bayesian",n),rep("last_3_months",n))
library(ggplot2)
ggplot(result, aes(x=customer_id, y=three_month_pred, colour=model)) + geom_line(size=1)
```

```{r}
index=which(bys$three_month_pred>150 & bys$three_month_pred<180)
result=rbind(xgb[index,],seq[index,],bys[index,],last_3_months[index,])
n=length(index)
result['model']=c(rep("boosting tree",n),rep("seq2seq",n),rep("bayesian",n),rep("last_3_months",n))
library(ggplot2)
ggplot(result, aes(x=customer_id, y=three_month_pred, colour=model)) + geom_line(size=1)
```

```{r}
index=which(bys$three_month_pred>250 & bys$three_month_pred<300)
result=rbind(xgb[index,],seq[index,],bys[index,],last_3_months[index,])
n=length(index)
result['model']=c(rep("boosting tree",n),rep("seq2seq",n),rep("bayesian",n),rep("last_3_months",n))
library(ggplot2)
ggplot(result, aes(x=customer_id, y=three_month_pred, colour=model)) + geom_line(size=1)
```

```{r}
index=which(bys$three_month_pred>500 & bys$three_month_pred<700)
result=rbind(xgb[index,],seq[index,],bys[index,],last_3_months[index,])
n=length(index)
result['model']=c(rep("boosting tree",n),rep("seq2seq",n),rep("bayesian",n),rep("last_3_months",n))
library(ggplot2)
ggplot(result, aes(x=customer_id, y=three_month_pred, colour=model)) + geom_line(size=1)
```

```{r}
index=which(bys$three_month_pred>1000)
result=rbind(xgb[index,],seq[index,],bys[index,],last_3_months[index,])
n=length(index)
result['model']=c(rep("boosting tree",n),rep("seq2seq",n),rep("bayesian",n),rep("last_3_months",n))
library(ggplot2)
ggplot(result, aes(x=customer_id, y=three_month_pred, colour=model)) + geom_line(size=1)
```

```{r}
index=which(bys$three_month_pred>10)
result=rbind(xgb[index,],seq[index,],last_3_months[index,])
n=length(index)
result['model']=c(rep("boosting tree",n),rep("seq2seq",n),rep("last_3_months",n))
library(ggplot2)
ggplot(result, aes(x=customer_id, y=three_month_pred, colour=model)) + geom_line(size=1)
```

From the graphs above we can see that the result from Gamma-Gamma model is very moderate (much smaller), the result from boosting tree model is the most dramatic and the result from seq2seq model fits well with the real numbers in the last 3 months (this is because Seq2seq mainly cares about generating look-alike series). Although I wasn't very confident with the seq2seq model, maybe it performs the best.From the last graph, we can see that for high value customers, the predicted result from boosting tree is the highest, then comes the real data from the last 3 months and the result from seq2seq model.

We then generate a new result combining the results of the three approach.

```{r}
new.result=xgb
new.result$three_month_pred=xgb$three_month_pred*0.4+bys$three_month_pred*0.2+seq$three_month_pred*0.4
index=which(bys$three_month_pred>10)
result=rbind(seq[index,],new.result[index,],last_3_months[index,])
n=length(index)
result['model']=c(rep("seq",n),rep("boosting tree+bayesian+seq",n),rep("last_3_months",n))
library(ggplot2)
ggplot(result, aes(x=customer_id, y=three_month_pred, colour=model)) + geom_line(size=1)
```

```{r}
index=which(bys$three_month_pred>150 & bys$three_month_pred<180)
result=rbind(seq[index,],new.result[index,],last_3_months[index,])
n=length(index)
result['model']=c(rep("seq",n),rep("boosting tree+bayesian+seq",n),rep("last_3_months",n))
library(ggplot2)
ggplot(result, aes(x=customer_id, y=three_month_pred, colour=model)) + geom_line(size=1)
```

```{r}
index=which(bys$three_month_pred>700 & bys$three_month_pred<800)
result=rbind(seq[index,],new.result[index,],last_3_months[index,])
n=length(index)
result['model']=c(rep("seq",n),rep("boosting tree+bayesian+seq",n),rep("last_3_months",n))
library(ggplot2)
ggplot(result, aes(x=customer_id, y=three_month_pred, colour=model)) + geom_line(size=1)
```

Although the weights I gave are quite arbitrary, I just want to have a try to see if our merged result can fit the future data well. With all the analysis above, I'm now curious about the accuracy for the result from seq2seq model and our merged result.

Now I have one more job to do. I need to mute some of the very small values (<5) to 0 to reduce error.

```{r}
mute=function(dataframe){
  i=which(dataframe$three_month_pred<5)
  dataframe$three_month_pred[i]=0
  return(dataframe)
}
bys=mute(bys)
xgb=mute(xgb)
seq=mute(seq)
new.result=mute(new.result)
write.csv(bys,"submit1.csv",row.names = FALSE)
write.csv(xgb,"submit2.csv",row.names = FALSE)
write.csv(seq,"submit3.csv",row.names = FALSE)
write.csv(new.result,"submit4.csv",row.names = FALSE)
```